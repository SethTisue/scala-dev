## Scala 2.13.4

Scala 2.13.4:

* Restores default global `ExecutionContext` to 2.12 behavior
* Improves pattern matching, especially in exhaustivity checking
* Adds experimental support for consuming libraries built by Scala 3

and more! Details below.

### Concurrency

**NOTE** This is a change in behaviour.  If you use `scala.concurrent.ExecutionContext.global` you may
want to adapt your code.  (But note that Akka is unaffected, because it uses its own execution contexts.)

In 2.13.0 we made `ExecutionContext.global` "opportunistic". This enabled "batching" of nested tasks
to execute on the same thread, avoiding an expensive context switch. That strategy requires
user code to wrap long-running and/or blocking tasks with `blocking { ... }` to maintain parallel
execution.

For 2.13.3, we restore 2.12's default non-batching behavior, which is safer for arbitrary user code. Users wanting
increased performance may override the default, if they believe their code uses `blocking` correctly.
We make that choice available via `ExecutionContext.opportunistic`.

In order to maintain forwards and backwards binary compatibility of the Scala standard library, the usage
instructions require some indirection.  Library authors can use the opportunistic execution context for all
Scala 2.13.x versions like so:

```scala
implicit val ec: scala.concurrent.ExecutionContext = try {
  scala.concurrent.ExecutionContext.getClass
    .getDeclaredMethod("opportunistic")
    .invoke(scala.concurrent.ExecutionContext)
    .asInstanceOf[scala.concurrent.ExecutionContext]
} catch {
  case _: NoSuchMethodException =>
    scala.concurrent.ExecutionContext.global
}
```

While application authors just need to gain access to the `private[scala]` field, which they can do by:

1. Using a structural type (example below) which uses Java runtime reflection.
1. Writing a Scala `object` in the `scala` package (example below).
1. Writing a Java source file. This works because `private[scala]` is emitted as `public` in Java bytecode.

For example (option 1):

```scala
implicit val ec: scala.concurrent.ExecutionContext =
  (scala.concurrent.ExecutionContext:
    {def opportunistic: scala.concurrent.ExecutionContextExecutor}
  ).opportunistic
```

Links:
* Issue: https://github.com/scala/bug/issues/12089
* PR: Revert ExecutionContext.global to not be a BatchingExecutor https://github.com/scala/scala/pull/9270
* PR: Introduce ExecutionContext.opportunistic for use in apps https://github.com/scala/scala/pull/9296
* Scaladoc: [ExecutionContext.global][https://www.scala-lang.org/api/2.13.4/scala/concurrent/ExecutionContext$.html#global:scala.concurrent.ExecutionContextExecutor]

### Pattern matching

The accuracy of exhaustivity checking for pattern matches has been greatly improved so that the following
variants in pattern matches no longer disable the exhaustivity checker:
* guards (`case <pattern> if <condition> => ...`) [#9140][]
* custom extractors (an object with an `unapply` or `unapplySeq`) [#9140][]
* unsealed types (via `-Xlint:strict-unsealed-patmat` opt-in, or just `-Xlint`) [#9140][]/[#9299][]
* private classes are now treated as "effectively sealed" [#9211](https://github.com/scala/scala/pull/9211)
* singleton types no longer prematurely widen [#9209](https://github.com/scala/scala/pull/9209)
* tuple values [#9147](https://github.com/scala/scala/pull/9147)/[#9163](https://github.com/scala/scala/pull/9163)/[#9147](https://github.com/scala/scala/pull/9147)
* case classes with a user-defined `unapply` or `unapplySeq` [#9162](https://github.com/scala/scala/pull/9162)

These warnings may be suppressed by:
1. annotating the scrutinee with `@unchecked`, such as `(foo: @unchecked) match { ... }`
2. using `-Wconf` to suppress the warning, something like `-Wconf:msg=match may not be exhaustive:i`
3. disabling the "strict" pattern matching for guards and custom extractors with `-Xnon-strict-patmat-analysis`
4. disabling the strict unsealed types pattern matching with `-Xlint:-strict-unsealed-patmat`

[#9140]: https://github.com/scala/scala/pull/9140
[#9299]: https://github.com/scala/scala/pull/9299

### Scala 3 interop

This release includes the brand new "Tasty Reader" to the Scala 2 compiler which allows, with some caveats
below, for libraries published by Scala 3 to be consumable by Scala 2 projects.  The caveats are that:

1. the Tasty Reader is brand new and experimental so it needs further testing, which is also why it's only
   present if you enable the `-Ytasty-reader` compiler option;
2. the libraries published by Scala 3 must only define an API that can be projected to the common language
   subset between Scala 2 and Scala 3;

For more details see the [Roadmap for the TASTy Reader For Scala 2][].

Links:
* PR: Add the Tasty Reader https://github.com/scala/scala/pull/9109
* PR: Putting it behind `-Ytasty-reader` https://github.com/scala/scala/pull/9293

[Roadmap for the TASTy Reader For Scala 2]: https://contributors.scala-lang.org/t/roadmap-for-the-tasty-reader-for-scala-2/4231

### Standard library changes

* Make the CharSequence wrappers in Predef non-implicit, for JDK 15 https://github.com/scala/scala/pull/9292
* Make LazyList.cons.apply lazier https://github.com/scala/scala/pull/9095
* Make MapView#values return a View https://github.com/scala/scala/pull/9090
* Make ListBuffer's iterator fail-fast https://github.com/scala/scala/pull/9174
* Un-deprecate useful StringOps operations https://github.com/scala/scala/pull/9246

### Compiler changes

* Enable range positions (`-Yrangepos`) by default https://github.com/scala/scala/pull/9146
    this mainly affects users of Scalameta SemanticDB, which previously required adding `-Yrangepos` to
    `scalacOptions` (continuing to supply the flag, for example when cross-building to 2.12, is harmless.)
* Allow using `classOf` with object type (e.g. `classOf[Foo.type]`) https://github.com/scala/scala/pull/9279
* Fix back-quoted constructor params with identical prefixes https://github.com/scala/scala/pull/9008

## Compatibility

As usual for our minor releases, Scala 2.13.4 is binary-compatible with the whole Scala 2.13 series.

Upgrading from 2.12? Enable `-Xmigration` while upgrading to request migration advice from the compiler.

## Contributors

A big thank you to everyone who's helped improve Scala by reporting bugs, improving our documentation, spreading kindness in discussions around Scala, and submitting and reviewing pull requests! You are all magnificent.

This release was brought to you by ?? contributors, according to `git shortlog -sn --no-merges HEAD ^v2.13.3 ^2.12.x`. Thank you ?, ??, ???.

Thanks to [Lightbend](https://www.lightbend.com/scala) for their continued sponsorship of the Scala core teamâ€™s efforts. Lightbend offers [commercial support](https://www.lightbend.com/lightbend-platform-subscription) for Scala.

## Scala 2.13 notes

The [release notes for Scala 2.13.0](https://github.com/scala/scala/releases/v2.13.0) have important information applicable to the whole 2.13 series.

## Obtaining Scala

Scala releases are available through a variety of channels, including (but not limited to):

* Bump the `scalaVersion` setting in your sbt-based project
* Download a distribution from [scala-lang.org](http://scala-lang.org/download/2.13.4.html)
* Obtain JARs via [Maven Central](http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22org.scala-lang%22%20AND%20v%3A%222.13.4%22)
